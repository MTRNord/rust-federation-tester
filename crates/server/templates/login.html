<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded">
    <head>
        <meta charset="utf-8" />
        <title>Sign in - Federation Tester</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, viewport-fit=cover"
        />
        <meta name="theme-color" content="#1d70b8" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/govuk-frontend@5.14.0/dist/govuk/govuk-frontend.min.css"
        />
        <style>
            /* Custom styles for non-GOV.UK components */
            .client-info-panel {
                padding: 15px;
                margin-bottom: 20px;
                background-color: #fff;
                border-left: 5px solid #1d70b8;
            }

            @media (min-width: 641px) {
                .client-info-panel {
                    padding: 20px;
                    margin-bottom: 30px;
                }
            }

            .client-info-panel__title {
                font-size: 1rem;
                font-weight: 700;
                margin: 0;
            }

            @media (min-width: 641px) {
                .client-info-panel__title {
                    font-size: 1.1875rem;
                }
            }

            .scope-list {
                margin: 0;
                padding: 0;
                list-style: none;
            }

            .scope-list__item {
                padding: 10px 0;
                border-bottom: 1px solid #b1b4b6;
                display: flex;
                align-items: flex-start;
            }

            .scope-list__item:last-child {
                border-bottom: none;
            }

            .scope-list__icon {
                width: 24px;
                height: 24px;
                margin-right: 15px;
                flex-shrink: 0;
                color: #00703c;
            }

            .scope-list__content {
                flex: 1;
            }

            .scope-list__name {
                font-weight: 700;
                margin-bottom: 2px;
            }

            .scope-list__description {
                font-size: 0.875rem;
                color: #505a5f;
            }

            @media (min-width: 641px) {
                .scope-list__description {
                    font-size: 1rem;
                }
            }

            .divider {
                display: flex;
                align-items: center;
                margin: 20px 0;
                color: #505a5f;
            }

            @media (min-width: 641px) {
                .divider {
                    margin: 30px 0;
                }
            }

            .divider::before,
            .divider::after {
                content: "";
                flex: 1;
                height: 1px;
                background: #b1b4b6;
            }

            .divider__text {
                padding: 0 20px;
                font-size: 0.875rem;
            }

            @media (min-width: 641px) {
                .divider__text {
                    font-size: 1rem;
                }
            }

            .hidden {
                display: none;
            }
        </style>
    </head>

    <body class="govuk-template__body">
        <script>
            document.body.className +=
                " js-enabled" +
                ("noModule" in HTMLScriptElement.prototype
                    ? " govuk-frontend-supported"
                    : "");
        </script>

        <a
            href="#main-content"
            class="govuk-skip-link"
            data-module="govuk-skip-link"
            >Skip to main content</a
        >

        <header class="govuk-header" data-module="govuk-header">
            <div class="govuk-header__container govuk-width-container">
                <div class="govuk-header__logo">
                    <a
                        href="/"
                        class="govuk-header__link govuk-header__link--homepage"
                    >
                        <span class="govuk-header__logotype">
                            <span class="govuk-header__logotype-text">
                                Federation Tester
                            </span>
                        </span>
                    </a>
                </div>
            </div>
        </header>

        <div class="govuk-width-container">
            <div class="govuk-phase-banner">
                <p class="govuk-phase-banner__content">
                    <strong class="govuk-tag govuk-phase-banner__content__tag"
                        >Beta</strong
                    >
                    <span class="govuk-phase-banner__text"
                        >This is a community service for testing Matrix
                        federation.</span
                    >
                </p>
            </div>

            <main class="govuk-main-wrapper" id="main-content" role="main">
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-two-thirds">
                        <h1 class="govuk-heading-l">Sign in</h1>

                        {% if let Some(client_name) = client_name %}
                        <div class="client-info-panel">
                            <p class="client-info-panel__title">
                                {{ client_name }} wants to access your account
                            </p>
                        </div>
                        {% endif %} {% if let Some(err) = error %}
                        <div
                            class="govuk-error-summary"
                            data-module="govuk-error-summary"
                        >
                            <div role="alert">
                                <h2 class="govuk-error-summary__title">
                                    There is a problem
                                </h2>
                                <div class="govuk-error-summary__body">
                                    <ul
                                        class="govuk-list govuk-error-summary__list"
                                    >
                                        <li>{{ err }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endif %} {% if let Some(msg) = message %}
                        <div
                            class="govuk-notification-banner govuk-notification-banner--success"
                            role="alert"
                            data-module="govuk-notification-banner"
                        >
                            <div class="govuk-notification-banner__header">
                                <h2
                                    class="govuk-notification-banner__title"
                                    id="govuk-notification-banner-title"
                                >
                                    Success
                                </h2>
                            </div>
                            <div class="govuk-notification-banner__content">
                                <p class="govuk-body">{{ msg }}</p>
                            </div>
                        </div>
                        {% endif %} {% if !scopes.is_empty() %}
                        <div class="govuk-inset-text">
                            <h2 class="govuk-heading-m">
                                Permissions requested
                            </h2>
                            <ul class="scope-list">
                                {% for scope in scopes %}
                                <li class="scope-list__item">
                                    <svg
                                        class="scope-list__icon"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                        aria-hidden="true"
                                        focusable="false"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                        ></path>
                                    </svg>
                                    <div class="scope-list__content">
                                        <div class="scope-list__name">
                                            {{ scope.name }}
                                        </div>
                                        <div class="scope-list__description">
                                            {{ scope.description }}
                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <form method="POST" action="/oauth2/login">
                            <input
                                type="hidden"
                                name="response_type"
                                value="{{ response_type }}"
                            />
                            <input
                                type="hidden"
                                name="client_id"
                                value="{{ client_id }}"
                            />
                            <input
                                type="hidden"
                                name="redirect_uri"
                                value="{{ redirect_uri }}"
                            />
                            <input
                                type="hidden"
                                name="scope"
                                value="{{ scope }}"
                            />
                            <input
                                type="hidden"
                                name="state"
                                value="{{ state }}"
                            />
                            {% if let Some(nonce) = nonce %}
                            <input
                                type="hidden"
                                name="nonce"
                                value="{{ nonce }}"
                            />
                            {% endif %} {% if let Some(challenge) =
                            code_challenge %}
                            <input
                                type="hidden"
                                name="code_challenge"
                                value="{{ challenge }}"
                            />
                            {% endif %} {% if let Some(method) =
                            code_challenge_method %}
                            <input
                                type="hidden"
                                name="code_challenge_method"
                                value="{{ method }}"
                            />
                            {% endif %}

                            <div class="govuk-form-group">
                                <label class="govuk-label" for="email"
                                    >Email address</label
                                >
                                <input
                                    class="govuk-input"
                                    type="email"
                                    id="email"
                                    name="email"
                                    value="{{ email }}"
                                    required
                                    autocomplete="email"
                                    autofocus
                                />
                            </div>

                            <div class="govuk-form-group">
                                <label class="govuk-label" for="password"
                                    >Password</label
                                >
                                <div class="govuk-hint">
                                    Leave blank to use magic link sign in
                                </div>
                                <input
                                    class="govuk-input"
                                    type="password"
                                    id="password"
                                    name="password"
                                    autocomplete="current-password"
                                />
                            </div>

                            <button
                                type="submit"
                                class="govuk-button"
                                data-module="govuk-button"
                            >
                                Sign in
                            </button>
                        </form>

                        <div class="divider">
                            <span class="divider__text">or</span>
                        </div>

                        <form method="POST" action="/oauth2/magic-link">
                            <input
                                type="hidden"
                                name="response_type"
                                value="{{ response_type }}"
                            />
                            <input
                                type="hidden"
                                name="client_id"
                                value="{{ client_id }}"
                            />
                            <input
                                type="hidden"
                                name="redirect_uri"
                                value="{{ redirect_uri }}"
                            />
                            <input
                                type="hidden"
                                name="scope"
                                value="{{ scope }}"
                            />
                            <input
                                type="hidden"
                                name="state"
                                value="{{ state }}"
                            />
                            {% if let Some(nonce) = nonce %}
                            <input
                                type="hidden"
                                name="nonce"
                                value="{{ nonce }}"
                            />
                            {% endif %} {% if let Some(challenge) =
                            code_challenge %}
                            <input
                                type="hidden"
                                name="code_challenge"
                                value="{{ challenge }}"
                            />
                            {% endif %} {% if let Some(method) =
                            code_challenge_method %}
                            <input
                                type="hidden"
                                name="code_challenge_method"
                                value="{{ method }}"
                            />
                            {% endif %}
                            <input
                                type="hidden"
                                name="email"
                                id="magic-email"
                            />

                            <button
                                type="submit"
                                class="govuk-button govuk-button--secondary"
                                data-module="govuk-button"
                                onclick="
                                    document.getElementById(
                                        'magic-email',
                                    ).value =
                                        document.getElementById('email').value
                                "
                            >
                                Sign in with magic link
                            </button>
                        </form>

                        <details class="govuk-details">
                            <summary class="govuk-details__summary">
                                <span class="govuk-details__summary-text"
                                    >What is a magic link?</span
                                >
                            </summary>
                            <div class="govuk-details__text">
                                <p class="govuk-body">
                                    A magic link is a secure, one-time sign in
                                    link sent to your email. Click the link in
                                    your email to sign in without entering a
                                    password.
                                </p>
                            </div>
                        </details>

                        <p class="govuk-body">
                            <a
                                class="govuk-link"
                                href="/oauth2/register?client_id={{ client_id }}&redirect_uri={{ redirect_uri }}&scope={{ scope }}&state={{ state }}&response_type={{ response_type }}"
                                >Create an account</a
                            >
                            if you do not have one.
                        </p>
                    </div>
                </div>
            </main>
        </div>

        <footer class="govuk-footer">
            <div class="govuk-width-container">
                <div class="govuk-footer__meta">
                    <div
                        class="govuk-footer__meta-item govuk-footer__meta-item--grow"
                    >
                        <span class="govuk-footer__licence-description">
                            Federation Tester is a community project for testing
                            Matrix homeserver federation.
                        </span>
                    </div>
                </div>
            </div>
        </footer>

        <script
            type="module"
            src="https://cdn.jsdelivr.net/npm/govuk-frontend@5.14.0/dist/govuk/govuk-frontend.min.js"
        ></script>
        <script type="module">
            import { initAll } from "https://cdn.jsdelivr.net/npm/govuk-frontend@5.14.0/dist/govuk/govuk-frontend.min.js";
            initAll();
        </script>
    </body>
</html>
